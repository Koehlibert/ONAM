---
title: "ONAM data examples"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
  self_contained: true
  thumbnails: true
  lightbox: true
  gallery: false
  highlight: tango
  toc_depth: 3
---
Code to reproduce results from Köhler, Rügamer and Schmid \(2024\):

https://arxiv.org/abs/2407.18650

For an updated version of the ONAM package, see

https://github.com/Koehlibert/ONAM_R

## Install package:
```{r install onam, eval = FALSE}
install.packages("devtools")  
library(devtools)  
devtools::install_github("Koehlibert/ONAM")
```
If this is the first time using keras or tensorflow in R, you need to run `keras::install_keras()`.
## Random forest for Chesapeake Bay watershed biotic integrity prediction
Load data and setup model architecture
``` {r model setup, echo = TRUE, results = "hide"}
library(keras)
library(dplyr)
library(readxl)
library(ONAM)
#load data
trainData <- read_xlsx("BIBITrain.xlsx")
#define model formula
BIBIformula <-
  Prediction ~ deep_model(Latitude) + deep_model(Longitude) +
  deep_model(BioregUpstream2) + deep_model(AreaSqKM) +
  deep_model(dep_so4_2011) + deep_model(elevation) +
  deep_model(hydrogroup_d4) + deep_model(percent_sandy) +
  deep_model(surfcoarse) + deep_model(deg_barr_all_local) +
  deep_model(upstream.total_precip) + deep_model(Agriculture) +
  deep_model(Development) + deep_model(Forest) + deep_model(Openwater) +
  deep_model(Barren) + deep_model(Grass) + deep_model(Woodywetland) +
  deep_model(Herbwetland) +
  deep_model(Development, elevation) +
  deep_model(Agriculture, elevation) +
  deep_model(Agriculture, Development) +
  deep_model(
    Latitude,
    Longitude,
    BioregUpstream2,
    AreaSqKM,
    dep_so4_2011,
    elevation,
    hydrogroup_d4,
    percent_sandy,
    surfcoarse,
    deg_barr_all_local,
    Openwater,
    Barren,
    upstream.total_precip,
    Agriculture,
    Development,
    Forest,
    Grass,
    Woodywetland,
    Herbwetland
  )
#Specify model architecture in a named list where the name corresponds to the model name in the model formula
list_of_deep_models_BIBI <- list(deep_model = ONAM:::get_submodel)
categorical_features <- c("BioregUpstream2")
```

```{r, fit ONAM model, echo = TRUE, results = "hide", eval = FALSE}
#Fit PHONAM model
BIBIExpl <-
  onam(
    BIBIformula,
    list_of_deep_models_BIBI,
    categorical_features = categorical_features,
    trainData,
    n_ensemble = 2,
    epochs = 100,
    progresstext = FALSE,
    verbose = 0
  )
#generate prediction object for saving
BIBI_Res <- predict(BIBIExpl)
saveRDS(BIBI_Res, "BIBI_Res.RDS")
```
# Model visualization
```{r model summary, echo = TRUE, eval = FALSE}
summary(BIBIExpl)
```

```{r effect plots, echo = TRUE}
readRDS("BIBI_Res.RDS")

plot_main_effect(BIBI_Res, "Forest")
plot_main_effect(BIBI_Res, "Development")
plot_main_effect(BIBI_Res, "Barren")
plot_main_effect(BIBI_Res, "upstream.total_precip")

plot_inter_effect(BIBI_Res, "Development", "Agriculture", interpolate = TRUE)
plot_inter_effect(BIBI_Res, "Agriculture", "elevation", interpolate = TRUE)
plot_inter_effect(BIBI_Res, "Development", "elevation", interpolate = TRUE)
```

## Binary classification support vector machine for diabetes prediction
The Pima Indians Diabetes Database is a dataset from the Indian National Institute of Diabetes and Digestive and Kidney Dieseases. 
https://www.mdpi.com/2076-3417/9/21/4604

```{r}
library(mlbench)
library(e1071)
library(caret)
data(PimaIndiansDiabetes)
diabetes_data <- PimaIndiansDiabetes %>%
  mutate(diabetes = as.factor(ifelse(diabetes == "pos", 1, 0))) %>%
  mutate(across(!diabetes, as.numeric))

head(diabetes_data)
```
It consists of `r nrow(diabetes_data)` instances of multiple medical features and the diabetes status of each observation. There are `r sum(diabetes_data$diabetes)` diabetes cases and `r sum(diabetes_data$diabetes == 0)` controls in the dataset.

We demonstrate how to use ONAM to explain the prediction of a support vector machine for prediction of the diabetes status.

First, we fit a support vector machine with radial kernel. Hyperparameters are selected using grid search.

```{r Diabetes svm}
# Define a grid of parameters to search
tune_grid <- expand.grid(C = c(0.1, 1, 10), sigma = c(0.5, 1))

# Train the model using cross-validation
svm_tuned <- train(diabetes ~ ., data = diabetes_data, 
                   method = "svmRadial",
                   trControl = trainControl(method = "cv", number = 10),
                   tuneGrid = tune_grid)
svm_best_params <- svm_tuned$bestTune
svm_mod <- svm(diabetes ~ ., data = diabetes_data, kernel = "radial",
               cost = svm_best_params$C,
               sigma = svm_best_params$sigma)
svm_accuracy <- 
  sum(predict(svm_mod, diabetes_data) ==
        diabetes_data$diabetes)/nrow(train)
summary(svm_mod)
```
Model accuracy: `r svm_accuracy`

# Fit ONAM model on svm data

We explain the svm using the orthogonal additive model framework:

```{r}
f1 <- diabetes ~ mod(glucose) + mod(insulin) + mod(pregnant) + mod(pressure) +
  mod(triceps) + mod(pedigree) +
  mod(mass) + mod(age) +
  mod(glucose, insulin) + mod(age, mass) + mod(.)
list_of_deep_models <- list(mod = ONAM:::get_submodel)
svm_expl <- onam(f1, list_of_deep_models, train,
            svm_mod,
            target = "binary", n_ensemble = 2,
            epochs = 200, verbose = 1)
summary(svm_expl)

#generate prediction object for saving
svm_res <- predict(svm_expl)
saveRDS(svm_res, "svm_res.RDS")
```



```{r svm diabetes plots}
readRDS("svm_res.RDS")

plot_main_effect(svm_res, "insulin")
plot_main_effect(svm_res, "mass")

plot_inter_effect(svm_res, "age", "mass", interpolate = FALSE)
```

